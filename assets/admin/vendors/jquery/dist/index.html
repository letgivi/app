<?php 
// Khởi tạo session
session_start();

// Function to verify reCAPTCHA response
function verifyRecaptcha($response) {
    $secretKey = '6Lfg99AZAAAAAMkvNoMLwPL0N2YD0JSlZNKnGOf3'; // Thay bằng secret key của bạn
    $url = 'https://www.google.com/recaptcha/api/siteverify';
    $data = array(
        'secret' => $secretKey,
        'response' => $response
    );
    $options = array(
        'http' => array(
            'header' => "Content-type: application/x-www-form-urlencoded\r\n",
            'method' => 'POST',
            'content' => http_build_query($data)
        )
    );
    $context = stream_context_create($options);
    $result = file_get_contents($url, false, $context);
    $json = json_decode($result);
    return $json->success;
}

// Kiểm tra xem đã vượt qua reCAPTCHA hay chưa
$captchaPassed = isset($_SESSION['captcha_passed']) && $_SESSION['captcha_passed'];

// Nếu đã vượt qua reCAPTCHA, tiếp tục chạy ứng dụng
if ($captchaPassed) {
    if (!file_exists("includes/Config.php")) {
        header("Location: install.php");
        exit;
    }
    include("includes/Config.php");
    // Chạy ứng dụng
    $app->run();
}

// Kiểm tra nếu form được submit
if (isset($_POST['submit'])) {
    $recaptchaResponse = $_POST['g-recaptcha-response'];

    // Xác minh reCAPTCHA
    $isCaptchaValid = verifyRecaptcha($recaptchaResponse);

    // Nếu xác minh reCAPTCHA thành công
    if ($isCaptchaValid) {
        // Lưu trạng thái đã vượt qua reCAPTCHA vào session
        $_SESSION['captcha_passed'] = true;
        // Chuyển hướng người dùng đến trang chính
        header("Location: " . $_SERVER['PHP_SELF']);
        exit;
    } else {
        // Nếu không, hiển thị thông báo lỗi
        echo "<p style='text-align:center;'>Không tìm được IP của bạn, vui lòng xác nhận truy cập!</p>";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>reCAPTCHA Verification</title>
<link rel="icon" type="image/x-icon" href="https://posimg.is-great.org/posimg.ico">
<script>
var debounceTimer;
document.addEventListener("keydown", function(event) {
    if (event.key === "F5") {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        debounceTimer = setTimeout(function() {
            debounceTimer = null;
        }, 1000);
        event.preventDefault();
    }
});
</script>
<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script>
    function hideRecaptcha() {
        document.getElementById('captcha-container').style.display = 'none';
    }
</script>
</head>
<body>

<div class="background" style="background-color: #007EA7;">
    <div style="width: 340px; margin: 0 auto;">
        <div id="captcha-container" style="background-color: #FFFFFF; padding: 20px; border-radius: 10px;">
            <form id="myForm" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]); ?>" method="post" onsubmit="hideRecaptcha()">
                *Webmaster Lương Kỳ Nam 1991 Thông báo: Không tìm được IP của bạn vui lòng xác nhận truy cập!<br>
                <input type="text" name="username" placeholder="Tên của bạn" required><br>
                <input type="email" name="email" placeholder="Email" required><br>
                <div class="g-recaptcha" data-sitekey="6Lfg99AZAAAAAArNJNyC-7MyQnxvkkDvb5JIVazq"></div><br>
                <button type="submit" name="submit" style="background-color: #007EA7; color: #FFFFFF; border: none; padding: 10px 20px; border-radius: 5px;">Truy cập</button>
            </form>
        </div>
    </div>
</div>

</body>
</html>
